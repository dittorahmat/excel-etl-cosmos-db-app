<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="IESR Excel Cosmos DB Dashboard & API" />
    <title>IESR Excel Cosmos DB Dashboard & API</title>

    <!-- Set a flag to prevent MSAL initialization before config loads -->
    <script>
      console.log('Initializing application...');

      // Set a flag to indicate we want to control MSAL initialization
      window.SKIP_MSAL_INIT = true;
      console.log('SKIP_MSAL_INIT set to:', window.SKAL_INIT);

      // Ensure global is defined for Node.js like environments
      window.global = window.global || window;

      // Ensure process is defined for libraries that expect it
      window.process = window.process || { env: {} };

      // Initialize environment variables if not already set
      window.ENV = window.ENV || {
        // Default all environment variables to ensure they're available
        VITE_AUTH_ENABLED: 'false',
        AUTH_ENABLED: 'false',
        NODE_ENV: 'production',
        MODE: 'production',
        // Add other environment variables that might be needed
        VITE_AZURE_CLIENT_ID: '',
        VITE_AZURE_TENANT_ID: '',
        VITE_AZURE_REDIRECT_URI: window.location.origin,
        VITE_API_SCOPE: '',
        VITE_API_BASE_URL: ''
      };

      // Override with any existing ENV values
      if (window.ENV_OVERRIDE) {
        Object.assign(window.ENV, window.ENV_OVERRIDE);
      }

      // Load config.js and then set authentication flags
      // This ensures we use the correct values from config.js
      function initializeAuth() {
        // Set authentication flags based on environment
        // Only force dummy auth if explicitly set to false AND not in development
        const isDevelopment = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1' ||
                             window.location.hostname.includes('localhost');
                             
        // Check if auth is explicitly enabled in environment or if we're in development
        const authExplicitlyEnabled = window.ENV.VITE_AUTH_ENABLED === 'true' || window.ENV.AUTH_ENABLED === 'true';
        
        if (!authExplicitlyEnabled && !isDevelopment) {
          // Only force dummy auth in production when auth is explicitly disabled
          window.ENV.VITE_AUTH_ENABLED = 'false';
          window.ENV.AUTH_ENABLED = 'false';
          window.FORCE_DUMMY_AUTH = true;
          window.USE_DUMMY_AUTH = true;
        } else if (authExplicitlyEnabled) {
          // If auth is explicitly enabled, make sure dummy auth flags are not set
          window.ENV.VITE_AUTH_ENABLED = 'true';
          window.ENV.AUTH_ENABLED = 'true';
          window.FORCE_DUMMY_AUTH = false;
          window.USE_DUMMY_AUTH = false;
        }
        
        console.log('Environment variables initialized:', window.ENV);
        console.log('Authentication mode - Explicitly enabled:', authExplicitlyEnabled, 'Is development:', isDevelopment);
      }

      // Error boundary for better error handling
      window.onerror = function(message, source, lineno, colno, error) {
        console.error('Global error:', { message, source, lineno, colno, error });
        return false; // Let the default handler run too
      };
    </script>

    <!-- Load the runtime config first -->
    <script src="/config.js"></script>
    
    <!-- Initialize authentication after config is loaded -->
    <script>
      initializeAuth();
    </script>

    <!-- CDN Cache Busting: 2025-08-12-1 -->
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>